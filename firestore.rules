rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Вспомогательные функции для валидации
    function isValidString(value, maxLength) {
      return value is string 
        && value.size() > 0 
        && value.size() <= maxLength;
    }
    
    function isValidEmail(email) {
      return email is string 
        && email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Правила для пользователей
    match /users/{userId} {
      // Пользователь может читать свой профиль
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Пользователь может создавать и обновлять только свой профиль
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && isValidString(request.resource.data.name, 100)
        && isValidEmail(request.resource.data.email);
        
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'email']) || 
             request.resource.data.uid == resource.data.uid && 
             request.resource.data.email == resource.data.email)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['name']) || 
             isValidString(request.resource.data.name, 100))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['bio']) || 
             !('bio' in request.resource.data) || 
             isValidString(request.resource.data.bio, 500));
      
      // Пользователь не может удалять свой профиль напрямую
      allow delete: if false;
    }

    // Правила для чатов
    match /chats/{chatId} {
      // Пользователь может читать чат только если он участник
      allow read: if request.auth != null 
        && request.auth.uid in resource.data.participants;
      
      // Пользователь может создавать чат, если он указан в participants
      allow create: if request.auth != null 
        && request.auth.uid in request.resource.data.participants;
      
      // Пользователь может обновлять чат только если он участник
      allow update: if request.auth != null 
        && request.auth.uid in resource.data.participants;
      
      // Пользователь может удалить чат только если он участник (можно добавить проверку на админа)
      allow delete: if request.auth != null 
        && request.auth.uid in resource.data.participants;

      // Правила для сообщений в чате
      match /messages/{messageId} {
        // Пользователь может читать сообщения только если он участник чата
        allow read: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Пользователь может создавать сообщения только если он участник чата
        allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && isValidString(request.resource.data.text, 10000)
          && request.resource.data.type in ['text', 'image', 'voice', 'sticker'];
        
        // Пользователь может обновлять только свои сообщения (например, статус)
        allow update: if request.auth != null 
          && request.auth.uid == resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['text']) || 
               isValidString(request.resource.data.text, 10000));
        
        // Пользователь может удалять только свои сообщения
        allow delete: if request.auth != null 
          && request.auth.uid == resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}

