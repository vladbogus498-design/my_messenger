rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Правила для пользователей
    match /users/{userId} {
      // Пользователь может читать свой профиль
      allow read: if request.auth != null && request.auth.uid == userId;
      // Пользователь может создавать и обновлять только свой профиль
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      // Пользователь не может удалять свой профиль напрямую
      allow delete: if false;
    }

    // Правила для чатов
    match /chats/{chatId} {
      // Пользователь может читать чат только если он участник
      allow read: if request.auth != null 
        && request.auth.uid in resource.data.participants;
      
      // Пользователь может создавать чат, если он указан в participants
      allow create: if request.auth != null 
        && request.auth.uid in request.resource.data.participants;
      
      // Пользователь может обновлять чат только если он участник
      allow update: if request.auth != null 
        && request.auth.uid in resource.data.participants;
      
      // Пользователь может удалить чат только если он участник (можно добавить проверку на админа)
      allow delete: if request.auth != null 
        && request.auth.uid in resource.data.participants;

      // Правила для сообщений в чате
      match /messages/{messageId} {
        // Пользователь может читать сообщения только если он участник чата
        allow read: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Пользователь может создавать сообщения только если он участник чата
        allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Пользователь может обновлять только свои сообщения (например, статус)
        allow update: if request.auth != null 
          && request.auth.uid == resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Пользователь может удалять только свои сообщения
        allow delete: if request.auth != null 
          && request.auth.uid == resource.data.senderId
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}

